name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

# Cancel in-progress runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  # ============================================
  # STAGE 1: Lint + Test (parallel, fast feedback)
  # ============================================
  lint:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting dependencies
        run: pip install flake8 black mypy
      
      - name: Run flake8 (critical errors only)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,build,dist,__pycache__,.hypothesis

  test:
    runs-on: windows-latest
    # Run test in parallel with lint, not after it
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term --cov-config=.coveragerc -x -q
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  # ============================================
  # STAGE 2: Build (only after lint + test pass)
  # ============================================
  build:
    runs-on: windows-latest
    needs: [lint, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # Cache PyInstaller bootloader + intermediate build artifacts
      - name: Cache PyInstaller build
        uses: actions/cache@v4
        with:
          path: |
            build
            ~\AppData\Local\pyinstaller
          key: ${{ runner.os }}-pyinstaller-${{ hashFiles('warehouse_app.spec', 'requirements.txt', 'main.py') }}
          restore-keys: |
            ${{ runner.os }}-pyinstaller-
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          pyinstaller warehouse_app.spec
      
      - name: Verify build
        run: |
          if (Test-Path "dist/WarehouseManagement.exe") {
            $file = Get-Item "dist/WarehouseManagement.exe"
            Write-Host "âœ… Build successful: $($file.Name) ($([math]::Round($file.Length / 1MB, 2)) MB)"
          } else {
            Write-Error "âŒ Build failed: executable not found"
            exit 1
          }
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WarehouseManagement-Windows-${{ github.sha }}
          path: dist/WarehouseManagement.exe
          retention-days: 30
          compression-level: 0  # Already compressed by PyInstaller

  rolling-release:
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache Inno Setup
        id: cache-inno
        uses: actions/cache@v4
        with:
          path: C:\Program Files (x86)\Inno Setup 6
          key: ${{ runner.os }}-innosetup-6.2

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          pyinstaller warehouse_app.spec

      - name: Install Inno Setup
        if: steps.cache-inno.outputs.cache-hit != 'true'
        run: |
          choco install innosetup -y --no-progress
      
      - name: Create installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss

      - name: Create Rolling Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: pc-latest
          name: Latest PC Build (Windows)
          files: |
            dist/WarehouseManagement.exe
            Output/BangTinhSetup.exe
          body: |
            ## PC Management App (Rolling Build)
            
            Báº£n build tá»± Ä‘á»™ng má»›i nháº¥t cho mÃ¡y tÃ­nh Windows.
            
            ### ðŸ“¥ Táº£i vá» (Chá»n 1 trong 2):
            1. **[WarehouseManagement.exe](https://github.com/${{ github.repository }}/releases/download/pc-latest/WarehouseManagement.exe)** (Báº£n Portable - Cháº¡y ngay khÃ´ng cáº§n cÃ i Ä‘áº·t)
            2. **[BangTinhSetup.exe](https://github.com/${{ github.repository }}/releases/download/pc-latest/BangTinhSetup.exe)** (Báº£n CÃ i Ä‘áº·t - CÃ³ Shortcut mÃ n hÃ¬nh vÃ  Start Menu)
            
            _Cáº­p nháº­t lÃºc: ${{ github.event.head_commit.timestamp }}_
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # STAGE 3: Release (only on release event)
  # ============================================
  release:
    runs-on: windows-latest
    needs: [lint, test]
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # Cache PyInstaller
      - name: Cache PyInstaller build
        uses: actions/cache@v4
        with:
          path: |
            build
            ~\AppData\Local\pyinstaller
          key: ${{ runner.os }}-pyinstaller-release-${{ hashFiles('warehouse_app.spec', 'requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pyinstaller-
      
      # Cache Inno Setup installation (saves ~2-3 minutes)
      - name: Cache Inno Setup
        id: cache-inno
        uses: actions/cache@v4
        with:
          path: C:\Program Files (x86)\Inno Setup 6
          key: ${{ runner.os }}-innosetup-6.2
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          pyinstaller warehouse_app.spec
      
      - name: Install Inno Setup
        if: steps.cache-inno.outputs.cache-hit != 'true'
        run: |
          choco install innosetup -y --no-progress
      
      - name: Create installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss
      
      - name: Get release version
        id: get_version
        run: |
          $version = "${{ github.event.release.tag_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      
      - name: Rename installer
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          if (Test-Path "Output/BangTinhSetup.exe") {
            Rename-Item "Output/BangTinhSetup.exe" "WarehouseManagement-Setup-$version.exe"
          }
      
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Output/WarehouseManagement-Setup-*.exe
            dist/WarehouseManagement.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
