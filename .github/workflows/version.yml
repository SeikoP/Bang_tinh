name: Version and Changelog

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - auto
          - major
          - minor
          - patch

jobs:
  version:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run version script
        if: github.event.inputs.bump_type == 'auto'
        run: |
          python scripts/version.py
      
      - name: Manual version bump
        if: github.event.inputs.bump_type != 'auto'
        run: |
          $latest_tag = git describe --tags --abbrev=0 2>$null
          if ($latest_tag) {
            $version = $latest_tag -replace '^v', ''
            $parts = $version.Split('.')
            $major = [int]$parts[0]
            $minor = [int]$parts[1]
            $patch = [int]$parts[2]
            
            switch ("${{ github.event.inputs.bump_type }}") {
              "major" { $major++; $minor=0; $patch=0 }
              "minor" { $minor++; $patch=0 }
              "patch" { $patch++ }
            }
            
            $new_version = "$major.$minor.$patch"
          } else {
            $new_version = "1.0.0"
          }
          
          echo "NEW_VERSION=$new_version" >> $env:GITHUB_ENV
          echo "New version: $new_version"
      
      - name: Commit and push changes
        run: |
          git add .
          git diff --staged --quiet || git commit -m "chore: bump version and update changelog"
          git push
      
      - name: Create and push tag
        if: github.event.inputs.bump_type != 'auto'
        run: |
          $tag = "v$env:NEW_VERSION"
          git tag -a $tag -m "Release $env:NEW_VERSION"
          git push origin $tag
